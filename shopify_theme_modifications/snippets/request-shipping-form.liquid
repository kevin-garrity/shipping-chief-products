<script>

  // Code to fetch the request form
  // TODO this info should live somewhere
  var host = "http://localhost:3000/"
  var action = "australia_post_api_connections"

  inject_shipping_calculator = function(data) {
    $('#shipping-calculator').html(data);
    $('#new_australia_post_api_connection').attr("action", host + action);
    $('.error').hide();
    $(".actions > input").click(ajax_request_calculation);
  };

  $.ajax({
    url: host + action,
    type: "GET",
    data: { weight: 20 },
    crossDomain: true,
    xhrFields: {
      withCredentials: true
    },
    success: inject_shipping_calculator
  }).fail(function() { console.log("fail") })
  .always(function() { console.log("always") })
  .complete(function() { console.log("complete") });

  $(function() { }); // what is this? Ah ha ha ha!

  ajax_request_calculation = function(data) {
    var country_code = $("select#australia_post_api_connection_country_code option:selected").attr("value");
    var to_postcode = $("input#australia_post_api_connection_to_postcode").val();
    var from_postcode = $("input#australia_post_api_connection_from_postcode").val();
    var weight = $("input#australia_post_api_connection_weight").val();

    var height = $("input#australia_post_api_connection_height").val();
    var width = $("input#australia_post_api_connection_width").val();
    var length = $("input#australia_post_api_connection_length").val();

    var dataHash = {
      weight: weight,
      to_postcode: to_postcode,
      from_postcode: from_postcode,
      country_code: country_code,
      height: height,
      width: width,
      length: length,
    }

    validate_and_process_form(dataHash);
    submit_calculation_request(dataHash);

    return false;
  }

  submit_calculation_request = function(dataHash) {
    tokentag = $('#tokentag').val()

    var params = {
      authenticity_token: tokentag,
      australia_post_api_connection: dataHash
    }

    $.ajaxSetup({
      beforeSend: function(xhr) {
        xhr.setRequestHeader('X-CSRF-TOKEN', tokentag);
      }
    });

    // Got the loader from http://www.ajaxload.info/
    $("#indicator").html("<img src='{{ 'ajax-loader.gif' | asset_url }}' alt='' />").show();
    $("#results").empty();

    $.ajax({
      type: "POST",
      url: host + action,
      data: params,
      success: function(data) {
        $("#indicator").empty().hide();
        $('#results').append(data);
      }
    }).fail(function() { console.log("fail") })
    .always(function() { console.log("always") })
    .complete(function() { console.log("complete") });

  }

  validate_and_process_form = function(dataHash) {
    // validate and process form here
    console.log(dataHash)
    console.log(dataHash['to_postcode'])
    $('.error').hide();

    // TODO
    //   So this seems weird: the heigh, width, and length are all calculated
    //   server side, then sent here to the client, and then returned to the
    //   server... this could be a risk I think, and it is surely inefficient

    // client side validation example
    if (dataHash['to_postcode'] === "") {
      $("#postcode > .error").show();
      $("input#australia_post_api_connection_to_postcode").focus();
      return false;
    }
  }


</script>
