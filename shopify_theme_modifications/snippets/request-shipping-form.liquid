<script>

  // Code to fetch the request form
  // TODO this info should live somewhere
  var host = "http://localhost:3000/"
  var action = "australia_post_api_connections"

  console.log("start")
  console.log($.version);
  $.ajax({
    url: host + action,
    type: "GET",
    data: { weight: 20 },
    crossDomain: true,
    xhrFields: {
      withCredentials: true
    },
    success: function(data) {
      console.log("success");
      $('#shipping-calculator').html(data);

      $('#new_australia_post_api_connection')
      .attr("action", host + action);

    console.log("in")
    $('.error').hide();

    $(".actions > input").click(function() {
      console.log("click")
      // validate and process form here
      $('.error').hide();

      // TODO
      //   So this seems weird: the heigh, width, and length are all calculated
      //   server side, then sent here to the client, and then returned to the
      //   server... this could be a risk I think, and it is surely inefficient
      var country_code = $("select#australia_post_api_connection_country_code option:selected").attr("value");
      console.log("country_code" + country_code)
      var to_postcode = $("input#australia_post_api_connection_to_postcode").val();
      var from_postcode = $("input#australia_post_api_connection_from_postcode").val();
      var weight = $("input#australia_post_api_connection_weight").val();

      var height = $("input#australia_post_api_connection_height").val();
      var width = $("input#australia_post_api_connection_width").val();
      var length = $("input#australia_post_api_connection_length").val();

      // client side validation example
      if (to_postcode === "") {
        $("#postcode > .error").show();
        $("input#australia_post_api_connection_to_postcode").focus();
        return false;
      }
      console.log("postcode OK")
      tokentag = $('#tokentag').val()

      var dataHash = {
        weight: weight,
        to_postcode: to_postcode,
        from_postcode: from_postcode,
        country_code: country_code,
        height: height,
        width: width,
        length: length,
      }

      var params = {
        authenticity_token: tokentag,
        australia_post_api_connection: dataHash
      }

      console.log("ajaxing...")
      console.log(dataHash);
      console.log(tokentag);

      $.ajaxSetup({
        beforeSend: function(xhr) {
          xhr.setRequestHeader('X-CSRF-TOKEN', tokentag);
        }
      });

      //alert (dataString);return false;
      $.ajax({
        type: "POST",
        url: host + action,
        data: params,
        success: function(data) {
          $('#shipping-prices').html(data);
        }
      }).fail(function() { console.log("fail") })
        .always(function() { console.log("always") })
        .complete(function() { console.log("complete") });
      return false;

    });

    }
  }).fail(function() { console.log("fail") })
  .always(function() { console.log("always") })
  .complete(function() { console.log("complete") });

  $(function() {
  });

</script>
